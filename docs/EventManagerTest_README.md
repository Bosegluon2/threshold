# EventManager 测试系统使用说明

## 概述

这个测试系统为 EventManager 提供了详细的测试功能，包括：
- 事件状态监控
- 任务完成测试
- 分支选择测试
- 防止分叉选择事件过期的机制

## 主要功能

### 1. 基础测试功能
- **测试事件系统按钮**: 显示当前所有活跃事件的详细信息
- **推进回合按钮**: 推进游戏回合，激活新事件，检查过期事件
- **实时状态显示**: 显示当前回合数和活跃事件数量

### 2. 事件UI组件
每个活跃事件都会显示一个独立的UI面板，包含：

#### 事件信息
- 事件名称
- 当前状态 (Inactive/Active/InProgress/Completed/Failed/Expired)
- 完成进度百分比

#### 任务信息
- 必需任务列表（状态、进度）
- 循环任务列表（状态、进度）
- 任务完成状态用颜色标识

#### 满足条件按钮
- 当事件处于 `Active` 状态且有必需任务时显示
- 点击后自动完成所有必需任务
- 任务完成后事件状态会推进到 `InProgress`

#### 分支选择
- 当事件处于 `InProgress` 状态且有分支选项时显示
- 显示所有可用的分支选项
- 每个分支显示名称和概率
- 选择分支后事件完成，后续事件激活

### 3. 分支类型系统
系统支持两种不同类型的分支：

#### 手动分支 (Manual)
- 每个选项都有enable条件，用于判断选项是否可用
- 用户可以看到所有可用选项并手动选择
- 支持复杂的条件组合（AND、OR、NOT）
- 例如：选择职业道路、选择对话选项

#### 自动分支 (Auto)
- 每个选项都有enable条件，按index顺序逐个评估
- 返回第一个满足条件的选项
- 系统自动处理，无需用户选择
- 例如：基于角色等级自动选择路径

### 4. 防止分叉选择事件过期
系统实现了智能的过期机制：
- 有分支选择的事件不会过期
- 常驻事件不会过期
- 确保用户有足够时间做出选择

## 测试流程

### 1. 初始化
1. 运行测试场景
2. 系统自动初始化事件森林
3. 激活根事件（测试事件1）

### 2. 任务完成测试
1. 查看事件状态（应该是 `Active`）
2. 点击"满足所有条件（完成任务）"按钮
3. 观察事件状态变化（变为 `InProgress`）
4. 查看分支选择按钮出现

### 3. 分支选择测试
1. 事件状态为 `InProgress` 时，分支选择按钮出现
2. 选择任意分支（如"选择路径A"）
3. 观察事件完成，后续事件激活
4. 推进回合查看新事件

### 4. 分支类型测试
1. **手动分支**: 查看分支信息显示 `[手动分支]` 标签，显示enable条件
2. **自动分支**: 推进回合时，自动分支会按index顺序评估条件并选择第一个满足的
3. **条件评估**: 查看分支的enable条件，了解选项的可用性要求

### 5. 推进回合测试
1. 点击"推进回合"按钮
2. 观察新事件激活
3. 查看过期事件处理
4. 验证分叉选择事件不会过期

## 测试数据

测试系统使用 `data/events/test_events.yaml` 文件，包含：

### 事件树结构
```
测试主线故事
├── 测试事件1 - 开始冒险 (根事件)
│   ├── 手动分支A: 路径A - 魔法学院 (需魔法学院可用)
│   │   └── 高级魔法课程
│   │       └── 魔法大师结局 (结束事件)
│   ├── 手动分支B: 路径B - 战士公会 (需战士公会可用)
│   │   └── 高级战斗技巧
│   │       └── 战斗大师结局 (结束事件)
│   └── 自动分支: 自动选择路径 (基于角色技能等级)
│       └── 路径A - 魔法学院 (如果魔法理论>5)
```

### 任务设计
- **收集信息**: 探索类任务，需要收集3个世界信息
- **学习魔法理论**: 训练类任务，学习基础魔法
- **基础战斗训练**: 训练类任务，学习基础战斗技能
- **高级魔法/战斗**: 最终训练任务，达到大师级别

## 技术特性

### 1. 事件状态管理
- 完整的事件生命周期管理
- 智能的任务依赖关系
- 分支选择的事件推进

### 2. UI组件系统
- 动态创建事件UI组件
- 实时更新事件状态
- 响应式按钮显示逻辑

### 3. 信号系统
- 事件激活/完成/过期信号
- 任务完成信号
- 实时UI更新

### 4. 过期保护机制
- 分叉选择事件保护
- 常驻事件保护
- 智能过期判断

## 扩展建议

### 1. 添加更多事件类型
- 世界事件
- 角色事件
- 随机事件

### 2. 增强任务系统
- 任务目标验证
- 任务奖励系统
- 任务失败处理

### 3. 改进分支系统
- 分支条件评估
- 分支概率动态调整
- 分支历史记录

### 4. 优化UI体验
- 动画效果
- 拖拽操作
- 快捷键支持

## 故障排除

### 常见问题
1. **事件不显示**: 检查事件数据文件格式
2. **按钮不响应**: 验证事件状态和任务配置
3. **分支不出现**: 确认事件已推进到 `InProgress` 状态

### 调试信息
- 控制台输出详细的事件状态变化
- 任务进度更新日志
- 分支选择过程记录

## 总结

这个测试系统为 EventManager 提供了全面的测试覆盖，特别关注：
- 事件状态流转的正确性
- 任务系统的完整性
- 分支选择的用户体验
- 过期机制的智能性

通过这个测试系统，开发者可以验证事件系统的各项功能，确保游戏逻辑的正确性和用户体验的流畅性。
